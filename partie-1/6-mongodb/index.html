<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.7.1">
<title>Des documents</title>
<link rel="stylesheet" href="./../../style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_des_documents">1. Des documents</a></li>
<li><a href="#_collections">2. Collections</a></li>
<li><a href="#_shell_javascript">3. Shell &amp; Javascript</a></li>
<li><a href="#_replica_sets">4. Replica Sets</a></li>
<li><a href="#_sharding">5. Sharding</a></li>
<li><a href="#_map_reduce">6. Map reduce</a></li>
<li><a href="#_sql_vs_mongodb">7. SQL vs MongoDB</a></li>
<li><a href="#_installation">8. Installation</a></li>
<li><a href="#_cr√©ation_du_r√©pertoire_de_donn√©es">9. Cr√©ation du r√©pertoire de donn√©es</a></li>
<li><a href="#_lancer_la_base">10. Lancer la base</a></li>
<li><a href="#_robomongo">11. Robomongo</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="paragraph">
<p><a href="../../index.html">&lt;&lt; Retour √† l&#8217;index</a></p>
</div>
<div class="imageblock">
<div class="content">
<img src="banner.png" alt="banner" width="100%">
</div>
</div>
<div class="paragraph">
<p>Mongo db est une base de donn√©es qui contient des documents.</p>
</div>
<div class="paragraph">
<p>Les donn√©es sont stock√©es en Binary JSON (BSON).</p>
</div>
<div class="paragraph">
<p>Nous allons l&#8217;utiliser afin de stocker nos donn√©es.</p>
</div>
<div class="sect1">
<h2 id="_des_documents">1. Des documents</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les documents Mongo db sont des structures arborescentes (du json) pouvant contenir des listes et des tableaux associatifs.</p>
</div>
<div class="paragraph">
<p>C&#8217;est une structure beaucoup plus riche qu&#8217;une base relationnelle par exemple</p>
</div>
<div class="listingblock">
<div class="title">exemple</div>
<div class="content">
<pre class="CodeRay highlight"><code>{
   _id: ObjectId("5099803df3f4948bd2f98391"),
   name: { first: "Alan", last: "Turing" },
   birth: new Date('Jun 23, 1912'),
   death: new Date('Jun 07, 1954'),
   contribs: [ "Turing machine", "Turing test", "Turingery" ],
   views : NumberLong(1250000)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est un arbre classique JSON avec un attribut _id de type ObjectId.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Not Only SQL (wikipedia)</div>
<div class="paragraph">
<p>En informatique, <strong>NoSQL</strong> (Not only SQL en anglais) d√©signe une cat√©gorie de syst√®mes de gestion de base de donn√©es (SGBD) qui n&#8217;est plus fond√©e sur l&#8217;architecture classique des <strong>bases relationnelles</strong>. L&#8217;unit√© logique n&#8217;y est plus la table, et les donn√©es ne sont en g√©n√©ral pas manipul√©es avec SQL.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_collections">2. Collections</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les documents sont rang√©s dans des <strong>collections</strong> (l&#8217;√©quivalent des tables en sql).</p>
</div>
<div class="paragraph">
<p>Les collections sont beaucoup moins rigides que les tables :
il n&#8217;y a pas de sch√©ma et donc chaque document peut avoir sa propre structure.</p>
</div>
<div class="paragraph">
<p>Pour la performance, il est tout a fait possible de placer des index comment dans une base SQL.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_shell_javascript">3. Shell &amp; Javascript</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pour interagir avec la base, il est possible d&#8217;utiliser le shell mongo.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>The mongo shell is an interactive <strong>JavaScript</strong> interface to MongoDB and is a component of the MongoDB package.
You can use the mongo shell to query and update data as well as perform administrative operations.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>L&#8217;<a href="https://docs.mongodb.org/manual/reference/method/" target="_blank" rel="noopener">api mongo</a> est riche et bien document√©e.</p>
</div>
<div class="listingblock">
<div class="title">Exemple de requ√™te</div>
<div class="content">
<pre>db.inventory.find( { type: 'food', price: { $lt: 9.95 } } ) <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>on cherche les documents de type 'food' avec un prix inf√©rieur √† 9.95 dans la collection 'inventory'</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En java, on utilise un <strong>driver</strong>.
Selon le language et les frameworks, la fa√ßon d&#8217;interagir avec la base mongo peut donc varier.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_replica_sets">4. Replica Sets</h2>
<div class="sectionbody">
<div class="paragraph">
<p>L&#8217;origine des bases NoSql vise la performance sur des volumes de donn√©es importants.</p>
</div>
<div class="paragraph">
<p>Mongodb propose des replica sets : un groupe de process qui maintiennent les m√™mes donn√©es.</p>
</div>
<div class="paragraph">
<p>Cela apporte <strong>haute disponibilit√©</strong> (tol√©rance √† la panne) et <strong>redondance</strong> (tol√©rance √† la perte de donn√©es sur un noeud).</p>
</div>
<div class="paragraph">
<p>Un replica set contient toujours un serveur primaire et des secondaires.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="replica-set.png" alt="replica set">
</div>
<div class="title">Figure 1. Replicat set</div>
</div>
<div class="paragraph">
<p>Pour augmenter la performance, il est possible que les clients viennent lire sur les secondaires.
Il se peut donc qu&#8217;au moment de la lecture, les donn√©es ne soient pas encore r√©pliqu√©es vers les secondaires.</p>
</div>
<div class="quoteblock">
<div class="title">Eventual Consistency</div>
<blockquote>
the storage system guarantees that if no new updates are made to the object, eventually all accesses will return the last updated value.
</blockquote>
<div class="attribution">
&#8212; Amazon<br>
<cite>Eventual Consistency</cite>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sharding">5. Sharding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le sharding est la segmentation des donn√©es en sous ensembles (par exemple les personnes dont le nom commence par [A-K] d&#8217;un cot√© et [L-Z] de l&#8217;autre).</p>
</div>
<div class="paragraph">
<p>Cela permet aux requ√™tes d&#8217;√™tre distribu√©es entres plusieurs serveurs afin de travailler sur des volumes plus faibles.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="shards.png" alt="shards">
</div>
<div class="title">Figure 2. Shards</div>
</div>
<div class="paragraph">
<p>Afin de pouvoir r√©partir une collection sur plusieurs serveurs, il faut d√©finir une cl√© de sharding.</p>
</div>
<div class="paragraph">
<p>Les donn√©es seront alors r√©parties en fonction de cette cl√©.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Logs</div>
<div class="paragraph">
<p>Un exemple de sharding pourrait concerner les logs : le volume est souvent imposant.</p>
</div>
<div class="paragraph">
<p>Il serait possible de diviser les logs en se basant sur la date du log.</p>
</div>
<div class="paragraph">
<p>Ainsi, les requ√™tes seraient r√©parties entre les noeuds pour plus de perfomance.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_map_reduce">6. Map reduce</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Une des op√©ration qui a rendu c√©l√®bre les bases NoSQL est le <strong>map-reduce</strong> : c&#8217;est un m√©canisme de traitement en masse des donn√©es afin de fournir un r√©sultat aggr√©g√©.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>map : transformation des r√©sultats</p>
</li>
<li>
<p>reduce : aggr√©gation du r√©sultat</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="map-reduce.png" alt="map reduce">
</div>
<div class="title">Figure 3. Map reduce</div>
</div>
<div class="paragraph">
<p>Le principe se marie id√©alement avec du sharding o√π les op√©ration peuvent op√©rer sur tous les noeuds en m√™me temps avant que le r√©sultat final soit aggr√©g√©.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sql_vs_mongodb">7. SQL vs MongoDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les qualit√©s d&#8217;une base SQL sont :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>A</strong> tomicit√© : une transaction se fait au complet ou pas du tout</p>
</li>
<li>
<p><strong>C</strong> oh√©rence : chaque transaction am√®nera le syst√®me d&#8217;un √©tat valide √† un autre √©tat valide</p>
</li>
<li>
<p><strong>I</strong> solation : toute transaction doit s&#8217;ex√©cuter comme si elle √©tait la seule sur le syst√®me</p>
</li>
<li>
<p><strong>D</strong> urabilit√© : une transaction finalis√©e alt√®re les donn√©es fa√ßon permanente et resistante √† la panne</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Or mongodb ne supporte ni transaction, ni cl√© √©trang√®re. Donc pas d'<strong>ACID</strong>it√©.</p>
</div>
<div class="paragraph">
<p>En contrepartie de ces d√©fauts, mongodb apporte plus de perfomance, plus de souplesse et plus de simplicit√©.</p>
</div>
<div class="paragraph">
<p>En fonction des contraintes, il faut donc choisir le bon type de base.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation">8. Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>‚á∞ Pour installer mongodb on passe par homebrew :</p>
</div>
<div class="listingblock terminal">
<div class="content">
<pre class="CodeRay highlight"><code>projects$ brew install mongodb
==&gt; Downloading https://homebrew.bintray.com/bottles/mongodb-3.0.6.yosemite.bottle.tar.gz
######################################################################## 100,0%
==&gt; Pouring mongodb-3.0.6.yosemite.bottle.tar.gz
==&gt; Caveats
To have launchd start mongodb at login:
  ln -sfv /usr/local/opt/mongodb/*.plist ~/Library/LaunchAgents
Then to load mongodb now:
  launchctl load ~/Library/LaunchAgents/homebrew.mxcl.mongodb.plist
Or, if you don't want/need launchctl, you can just run:
  mongod --config /usr/local/etc/mongod.conf
==&gt; Summary
üç∫  /usr/local/Cellar/mongodb/3.0.6: 17 files, 159M</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cr√©ation_du_r√©pertoire_de_donn√©es">9. Cr√©ation du r√©pertoire de donn√©es</h2>
<div class="sectionbody">
<div class="listingblock terminal">
<div class="content">
<pre class="CodeRay highlight"><code>projects$ mkdir mongodb-data <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ce r√©pertoire contiendra les donn√©es de la base</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lancer_la_base">10. Lancer la base</h2>
<div class="sectionbody">
<div class="paragraph">
<p>‚á∞ Une fois install√©e, il suffit de lancer la base.</p>
</div>
<div class="listingblock terminal">
<div class="content">
<pre class="CodeRay highlight"><code>projects$ mongod --dbpath mongodb-data
2018-08-16T16:24:46.478+0200 I CONTROL  [main] Automatically disabling TLS 1.0, to force-enable TLS 1.0 specify --sslDisabledProtocols 'none'
2018-08-16T16:24:46.494+0200 I CONTROL  [initandlisten] MongoDB starting : pid=35591 port=27017 dbpath=mongodb-data 64-bit host=MKS014673.local
2018-08-16T16:24:46.494+0200 I CONTROL  [initandlisten] db version v4.0.1
2018-08-16T16:24:46.494+0200 I CONTROL  [initandlisten] git version: 54f1582fc6eb01de4d4c42f26fc133e623f065fb
2018-08-16T16:24:46.494+0200 I CONTROL  [initandlisten] allocator: system
2018-08-16T16:24:46.494+0200 I CONTROL  [initandlisten] modules: none
2018-08-16T16:24:46.495+0200 I CONTROL  [initandlisten] build environment:
2018-08-16T16:24:46.495+0200 I CONTROL  [initandlisten]     distarch: x86_64
2018-08-16T16:24:46.495+0200 I CONTROL  [initandlisten]     target_arch: x86_64
2018-08-16T16:24:46.495+0200 I CONTROL  [initandlisten] options: { storage: { dbPath: "mongodb-data" } }
2018-08-16T16:24:46.495+0200 I STORAGE  [initandlisten] wiredtiger_open config: create,cache_size=7680M,session_max=20000,eviction=(threads_min=4,threads_max=4),config_base=false,statistics=(fast),log=(enabled=true,archive=true,path=journal,compressor=snappy),file_manager=(close_idle_time=100000),statistics_log=(wait=0),verbose=(recovery_progress),
2018-08-16T16:24:47.911+0200 I STORAGE  [initandlisten] WiredTiger message [1534429487:911056][35591:0x7fff9c05f340], txn-recover: Set global recovery timestamp: 0
2018-08-16T16:24:48.327+0200 I RECOVERY [initandlisten] WiredTiger recoveryTimestamp. Ts: Timestamp(0, 0)
2018-08-16T16:24:48.799+0200 I CONTROL  [initandlisten]
2018-08-16T16:24:48.799+0200 I CONTROL  [initandlisten] ** WARNING: Access control is not enabled for the database.
2018-08-16T16:24:48.799+0200 I CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.
2018-08-16T16:24:48.799+0200 I CONTROL  [initandlisten]
2018-08-16T16:24:48.799+0200 I CONTROL  [initandlisten] ** WARNING: This server is bound to localhost.
2018-08-16T16:24:48.799+0200 I CONTROL  [initandlisten] **          Remote systems will be unable to connect to this server.
2018-08-16T16:24:48.799+0200 I CONTROL  [initandlisten] **          Start the server with --bind_ip &lt;address&gt; to specify which IP
2018-08-16T16:24:48.799+0200 I CONTROL  [initandlisten] **          addresses it should serve responses from, or with --bind_ip_all to
2018-08-16T16:24:48.799+0200 I CONTROL  [initandlisten] **          bind to all interfaces. If this behavior is desired, start the
2018-08-16T16:24:48.799+0200 I CONTROL  [initandlisten] **          server with --bind_ip 127.0.0.1 to disable this warning.
2018-08-16T16:24:48.799+0200 I CONTROL  [initandlisten]
2018-08-16T16:24:48.805+0200 I STORAGE  [initandlisten] createCollection: admin.system.version with provided UUID: 241c468b-6e34-4cab-9074-3d6c5cf55f59
2018-08-16T16:24:49.890+0200 I COMMAND  [initandlisten] setting featureCompatibilityVersion to 4.0
2018-08-16T16:24:49.894+0200 I STORAGE  [initandlisten] createCollection: local.startup_log with generated UUID: eab45841-f3c4-494d-9d42-67862d3138ef
2018-08-16T16:24:50.358+0200 I FTDC     [initandlisten] Initializing full-time diagnostic data capture with directory 'mongodb-data/diagnostic.data'
2018-08-16T16:24:50.361+0200 I NETWORK  [initandlisten] waiting for connections on port 27017 <i class="conum" data-value="1"></i><b>(1)</b>
2018-08-16T16:24:50.361+0200 I STORAGE  [LogicalSessionCacheRefresh] createCollection: config.system.sessions with generated UUID: a4d0c32e-e38e-4e61-b51f-4f0e9c3b7ec7
2018-08-16T16:24:50.569+0200 I INDEX    [LogicalSessionCacheRefresh] build index on: config.system.sessions properties: { v: 2, key: { lastUse: 1 }, name: "lsidTTLIndex", ns: "config.system.sessions", expireAfterSeconds: 1800 }
2018-08-16T16:24:50.569+0200 I INDEX    [LogicalSessionCacheRefresh] 	 building index using bulk method; build may temporarily use up to 500 megabytes of RAM
2018-08-16T16:24:50.586+0200 I INDEX    [LogicalSessionCacheRefresh] build index done.  scanned 0 total records. 0 secs
2018-08-16T16:24:50.586+0200 I COMMAND  [LogicalSessionCacheRefresh] command config.$cmd command: createIndexes { createIndexes: "system.sessions", indexes: [ { key: { lastUse: 1 }, name: "lsidTTLIndex", expireAfterSeconds: 1800 } ], $db: "config" } numYields:0 reslen:114 locks:{ Global: { acquireCount: { r: 1, w: 1 } }, Database: { acquireCount: { W: 1 } }, Collection: { acquireCount: { w: 1 } } } protocol:op_msg 225ms</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>La base √©coute sur le port 27017</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La base est pr√™te √† recevoir des connexions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_robomongo">11. Robomongo</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On pourrait utiliser le shell mais une interface graphique est plus simple pour visualiser les r√©sultats des requ√™tes.</p>
</div>
<div class="paragraph">
<p>Il existe beaucoup de clients graphiques.</p>
</div>
<div class="paragraph">
<p>Nous utiliserons <a href="https://robomongo.org/">Robo 3T</a>.</p>
</div>
<div class="paragraph">
<p>‚á∞ Installez ce logiciel et connectez vous √† la base en local sur le port 27017.</p>
</div>
<div class="paragraph">
<p>Une fois connect√©, vous pouvez cr√©er une base, des collections et faire de multiples <a href="https://docs.mongodb.org/manual/tutorial/query-documents/">requ√™tes</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="robomongo.png" alt="robomongo">
</div>
</div>
<div class="paragraph">
<p><a href="../../index.html">&lt;&lt; Retour √† l&#8217;index</a></p>
</div>
</div>
</div>
</div>
</body>
</html>